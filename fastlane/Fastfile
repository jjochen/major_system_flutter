
platform :ios do
  desc 'Push a new beta build to TestFlight'
  lane :beta do
    xcversion(version: '~> 12.4')

    match(type: 'appstore')

    UI.message("Build flutter library")
    Dir.chdir('..') do
      sh 'fvm flutter clean'
      sh 'fvm flutter doctor'
      sh 'fvm flutter pub get'
      sh 'fvm flutter build ios --release --no-codesign'
    end

    build_app(workspace: 'ios/Runner.xcworkspace', scheme: 'Runner')

    upload_to_testflight
  end
end

platform :android do
  desc "Submit a new Beta Build to Crashlytics Beta"
  lane :beta do
    UI.message("Build flutter library")
    Dir.chdir('..') do
      sh 'fvm flutter clean'
      sh 'fvm flutter doctor'
      sh 'fvm flutter pub get'
      sh 'fvm flutter build appbundle'
    end

    upload_to_play_store(track: 'beta', aab: 'build/app/outputs/bundle/release/app-release.aab')
  end

  desc "Deploy a new version to the Google Play"
  lane :release do
    UI.message("Build flutter library")
    Dir.chdir('..') do
      sh 'fvm flutter clean'
      sh 'fvm flutter doctor'
      sh 'fvm flutter pub get'
      sh 'fvm flutter build appbundle'
    end

    upload_to_play_store(track: 'production', aab: 'build/app/outputs/bundle/release/app-release.aab')
  end
end
